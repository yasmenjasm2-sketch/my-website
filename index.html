<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Senpa Pro Engine - Ultra Edition</title>
<style>
    body { margin: 0; overflow: hidden; background: #050505; font-family: 'Segoe UI', sans-serif; user-select: none; }
    canvas { display: block; }
    
    /* واجهة القائمة */
    #ui-container {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; align-items: center; justify-content: center;
        background: rgba(0,0,0,0.8); z-index: 10;
    }
    
    .menu-box {
        background: #111; padding: 30px; border-radius: 20px;
        box-shadow: 0 0 40px #00d2ff33; text-align: center;
        width: 380px; color: #fff; border: 1px solid #222;
    }
    
    h1 { margin: 0 0 20px; color: #00d2ff; text-transform: uppercase; letter-spacing: 3px; font-size: 30px; }
    input, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; font-size: 16px; box-sizing: border-box; }
    input { background: #1a1a1a; color: #fff; border: 1px solid #333; }
    button { cursor: pointer; font-weight: bold; transition: 0.3s; }
    #play-btn { background: #00d2ff; color: #000; }
    #play-btn:hover { background: #fff; }
    #settings-btn { background: #333; color: #fff; }

    /* قائمة الإعدادات */
    #settings-menu {
        display: none; position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%); background: #111;
        padding: 30px; border-radius: 15px; z-index: 20;
        width: 350px; color: #fff; border: 2px solid #00d2ff;
    }
    .key-bind { display: flex; justify-content: space-between; align-items: center; margin: 15px 0; }
    .key-btn { background: #222; color: #ffeb3b; width: 120px; padding: 8px; text-align: center; border: 1px solid #444; }
    .key-btn.listening { background: #f44336; color: #fff; }
    #close-settings { background: #00d2ff; color: #000; margin-top: 20px; }

    #stats { position: absolute; top: 20px; left: 20px; color: #00d2ff; font-family: monospace; font-size: 18px; pointer-events: none; }
</style>
</head>
<body>

<div id="ui-container">
    <div class="menu-box">
        <h1>SENPA ULTRA</h1>
        <input id="nickname" placeholder="اسمك البطولي" maxlength="15">
        <input id="skin-url" placeholder="رابط السكن">
        <button id="play-btn">ابدأ الهجوم</button>
        <button id="settings-btn">تخصيص الأزرار</button>
    </div>
</div>

<div id="settings-menu">
    <h3 style="text-align: center; color: #00d2ff;">تخصيck الأزرار</h3>
    <div class="key-bind"><span>إطلاق هجوم (Enter)</span><button class="key-btn" id="btn-special" onclick="bindKey('special')">Enter</button></div>
    <div class="key-bind"><span>ماكرو 80 حبة</span><button class="key-btn" id="btn-macro" onclick="bindKey('macro')">E</button></div>
    <div class="key-bind"><span>انقسام عادي</span><button class="key-btn" id="btn-split" onclick="bindKey('split')">Space</button></div>
    <div class="key-bind"><span>إطلاق مفرد</span><button class="key-btn" id="btn-feed" onclick="bindKey('feed')">W</button></div>
    <button id="close-settings">حفظ</button>
</div>

<div id="stats">Mass: <span id="score">0</span> | الأجزاء: <span id="cell-count">0</span></div>
<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

let gameState = { running: false, width: 8000, height: 8000, camera: { x: 0, y: 0, zoom: 1 } };
let controls = { special: 'Enter', macro: 'KeyE', split: 'Space', feed: 'KeyW' };

// استرجاع الإعدادات
if(localStorage.getItem('senpaUltraConfig')) controls = JSON.parse(localStorage.getItem('senpaUltraConfig'));

let nodes = { player: [], food: [], enemies: [] };
let mouse = { x: 0, y: 0 };
let skinImage = null;
let isBursting = false;

class Node {
    constructor(x, y, size, color) {
        this.x = x; this.y = y; this.size = size; this.color = color;
        this.mass = (size * size) / 100;
        this.deleted = false;
    }
    setMass(m) { this.mass = m; this.size = Math.sqrt(m * 100); }
}

class PlayerCell extends Node {
    constructor(x, y, size, color, name, mergeDelay = 10000) {
        super(x, y, size, color);
        this.name = name;
        this.vx = 0; this.vy = 0;
        // زمن الاندماج: الافتراضي 10 ثواني، لكن للهجوم الخاص 50 ثانية
        this.mergeReadyTime = Date.now() + mergeDelay;
    }

    move() {
        // حركة أبطأ وأكثر احترافية
        let speed = 2.2 * Math.pow(this.size, -0.45) * 15; 
        let targetX = (mouse.x - canvas.width/2) / gameState.camera.zoom + gameState.camera.x;
        let targetY = (mouse.y - canvas.height/2) / gameState.camera.zoom + gameState.camera.y;

        let dx = targetX - this.x;
        let dy = targetY - this.y;
        let dist = Math.sqrt(dx*dx + dy*dy);

        if (dist > 5) {
            this.vx += (dx / dist) * speed * 0.1;
            this.vy += (dy / dist) * speed * 0.1;
        }

        this.vx *= 0.93; // احتكاك عالي للتحكم
        this.vy *= 0.93;
        this.x += this.vx; this.y += this.vy;
        
        // حدود الخريطة
        this.x = Math.max(this.size, Math.min(gameState.width - this.size, this.x));
        this.y = Math.max(this.size, Math.min(gameState.height - this.size, this.y));
    }

    draw() {
        ctx.save();
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fillStyle = this.color;
        ctx.fill();
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 2;
        ctx.stroke();
        
        if (skinImage) {
            ctx.clip();
            ctx.drawImage(skinImage, this.x - this.size, this.y - this.size, this.size * 2, this.size * 2);
        }
        ctx.restore();

        // رسم الاسم والكتلة
        ctx.fillStyle = "#fff";
        ctx.textAlign = "center";
        ctx.font = `bold ${this.size/3}px Arial`;
        ctx.fillText(Math.floor(this.mass), this.x, this.y + this.size/4);
    }
}

// دالة الماكرو 80 حبة بضغطة واحدة
function startMacro80() {
    if (isBursting) return;
    isBursting = true;
    let count = 0;
    let interval = setInterval(() => {
        if (count >= 80 || !gameState.running) {
            clearInterval(interval);
            isBursting = false;
            return;
        }
        ejectMass();
        count++;
    }, 5); // سرعة فائقة جداً (5 مللي ثانية)
}

function ejectMass() {
    nodes.player.forEach(cell => {
        if (cell.mass < 150) return;
        cell.setMass(cell.mass - 20);
        // توليد طلقة (كتلة سكر)
        let angle = Math.atan2(mouse.y - canvas.height/2, mouse.x - canvas.width/2);
        let food = new Node(cell.x + Math.cos(angle)*cell.size, cell.y + Math.sin(angle)*cell.size, 15, cell.color);
        nodes.food.push(food);
    });
}

// دالة الإطلاق الخاص (Pop-Split) - 50 ثانية اندماج
function specialAttack() {
    let newCells = [];
    nodes.player.forEach(cell => {
        if (cell.mass < 500) return;
        let angle = Math.atan2(mouse.y - canvas.height/2, mouse.x - canvas.width/2);
        
        let splitMass = cell.mass / 2;
        cell.setMass(splitMass);
        
        // الجزء الجديد يندمج بعد 50 ثانية (50000 مللي ثانية)
        let child = new PlayerCell(cell.x, cell.y, cell.size, cell.color, cell.name, 50000);
        child.setMass(splitMass);
        child.vx = Math.cos(angle) * 60;
        child.vy = Math.sin(angle) * 60;
        newCells.push(child);
    });
    nodes.player = nodes.player.concat(newCells);
}

// المحرك الرئيسي
function loop() {
    if (!gameState.running) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // خلفية الشبكة
    drawGrid();

    let totalMass = 0;
    let avgX = 0, avgY = 0;

    // تحديث اللاعب
    nodes.player.forEach((p, i) => {
        p.move();
        p.draw();
        totalMass += p.mass;
        avgX += p.x; avgY += p.y;

        // أكل الطعام
        nodes.food.forEach((f, fi) => {
            let d = Math.hypot(p.x - f.x, p.y - f.y);
            if (d < p.size) {
                p.setMass(p.mass + (f.size/2));
                nodes.food.splice(fi, 1);
            }
        });

        // تصادم الأجزاء والاندماج
        nodes.player.forEach((p2, i2) => {
            if (i === i2) return;
            let d = Math.hypot(p.x - p2.x, p.y - p2.y);
            if (d < p.size + p2.size) {
                // إذا مر وقت الاندماج (للإطلاق الخاص سيكون بعد 50 ثانية)
                if (Date.now() > p.mergeReadyTime && Date.now() > p2.mergeReadyTime) {
                    p.setMass(p.mass + p2.mass);
                    nodes.player.splice(i2, 1);
                } else {
                    // تدافع فيزيائي إذا لم يحن وقت الاندماج
                    let push = (p.size + p2.size - d) / 2;
                    let ang = Math.atan2(p2.y - p.y, p2.x - p.x);
                    p2.x += Math.cos(ang) * push;
                    p2.y += Math.sin(ang) * push;
                }
            }
        });
    });

    // كاميرا ناعمة
    if (nodes.player.length > 0) {
        gameState.camera.x += (avgX / nodes.player.length - gameState.camera.x) * 0.1;
        gameState.camera.y += (avgY / nodes.player.length - gameState.camera.y) * 0.1;
    }

    document.getElementById("score").innerText = Math.floor(totalMass);
    document.getElementById("cell-count").innerText = nodes.player.length;
    
    // الحفاظ على الطعام
    if (nodes.food.length < 500) spawnFood();

    requestAnimationFrame(loop);
}

function spawnFood() {
    nodes.food.push(new Node(Math.random()*gameState.width, Math.random()*gameState.height, 8, `hsl(${Math.random()*360}, 100%, 50%)`));
}

function drawGrid() {
    ctx.save();
    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.scale(gameState.camera.zoom, gameState.camera.zoom);
    ctx.translate(-gameState.camera.x, -gameState.camera.y);
    
    ctx.strokeStyle = "#222";
    ctx.lineWidth = 2;
    for(let i=0; i<=gameState.width; i+=100) {
        ctx.moveTo(i, 0); ctx.lineTo(i, gameState.height);
        ctx.moveTo(0, i); ctx.lineTo(gameState.width, i);
    }
    ctx.stroke();
    ctx.restore();
}

// التحكم
window.addEventListener('keydown', (e) => {
    if (document.activeElement.tagName === "INPUT") return;
    
    if (listeningFor) {
        controls[listeningFor] = e.code;
        updateUI();
        listeningFor = null;
        localStorage.setItem('senpaUltraConfig', JSON.stringify(controls));
        return;
    }

    if (e.code === controls.macro) startMacro80();
    if (e.code === controls.special || e.key === "Enter") specialAttack();
    if (e.code === controls.split) splitCell();
    if (e.code === controls.feed) ejectMass();
});

function splitCell() {
    // انقسام عادي (اندماج بعد 10 ثواني)
    let newCells = [];
    nodes.player.forEach(cell => {
        if (cell.mass < 100 || nodes.player.length >= 16) return;
        let angle = Math.atan2(mouse.y - canvas.height/2, mouse.x - canvas.width/2);
        cell.setMass(cell.mass / 2);
        let child = new PlayerCell(cell.x, cell.y, cell.size, cell.color, cell.name, 10000);
        child.setMass(cell.mass);
        child.vx = Math.cos(angle) * 50; child.vy = Math.sin(angle) * 50;
        newCells.push(child);
    });
    nodes.player = nodes.player.concat(newCells);
}

// UI
document.getElementById("play-btn").onclick = () => {
    playerConfig = { name: document.getElementById("nickname").value || "Hero" };
    let url = document.getElementById("skin-url").value;
    if (url) { skinImage = new Image(); skinImage.src = url; }
    
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    nodes.player = [new PlayerCell(gameState.width/2, gameState.height/2, 50, "#00d2ff", playerConfig.name)];
    document.getElementById("ui-container").style.display = "none";
    gameState.running = true;
    loop();
};

document.getElementById("settings-btn").onclick = () => document.getElementById("settings-menu").style.display = "block";
document.getElementById("close-settings").onclick = () => document.getElementById("settings-menu").style.display = "none";

let listeningFor = null;
function bindKey(type) {
    listeningFor = type;
    document.getElementById('btn-'+type).innerText = "اضغط زر...";
    document.getElementById('btn-'+type).classList.add('listening');
}

function updateUI() {
    Object.keys(controls).forEach(k => {
        let btn = document.getElementById('btn-'+k);
        if(btn) {
            btn.innerText = controls[k].replace('Key', '');
            btn.classList.remove('listening');
        }
    });
}

window.addEventListener('mousemove', (e) => { mouse.x = e.clientX; mouse.y = e.clientY; });
updateUI();
</script>
</body>
</html>
